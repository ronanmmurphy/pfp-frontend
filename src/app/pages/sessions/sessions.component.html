<div class="py-3">
  <!-- Filters -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Search</label>
          <input
            type="text"
            class="form-control form-control-sm"
            placeholder="Search by photographer or veteran"
            [formControl]="form.controls.search"
          />
        </div>

        <div class="col-md-2">
          <label class="form-label">Status</label>
          <select class="form-control form-control-sm" [formControl]="form.controls.status">
            <option value="">All</option>
            <option [ngValue]="SessionStatus.REQUESTED">Requested</option>
            <option [ngValue]="SessionStatus.SCHEDULED">Scheduled</option>
            <option [ngValue]="SessionStatus.RESCHEDULE_REQUESTED">Reschedule Requested</option>
            <option [ngValue]="SessionStatus.COMPLETED">Completed</option>
            <option [ngValue]="SessionStatus.CANCELED">Canceled</option>
          </select>
        </div>

        <div class="col-md-2">
          <label class="form-label">From</label>
          <input type="date" class="form-control form-control-sm" [formControl]="form.controls.dateFrom" />
        </div>

        <div class="col-md-2">
          <label class="form-label">To</label>
          <input type="date" class="form-control form-control-sm" [formControl]="form.controls.dateTo" />
        </div>

        <div class="col-md-2">
          <button class="btn btn-primary w-100 mb-2" type="button" (click)="requestSession()" *ngIf="role === UserRole.VETERAN">
            Request a Session
          </button>
          <button class="btn btn-outline-primary w-100" (click)="resetFilters()">Reset</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Sessions -->
  <div class="card">
    <div class="card-body">
      <div *ngIf="loading" class="text-muted mb-2">Loadingâ€¦</div>

      <div class="table-responsive" *ngIf="!loading">
        <table class="table table-hover mb-0">
          <thead>
            <tr>
              <th>Session Name</th>
              <th>Date</th>
              <th *ngIf="role !== UserRole.PHOTOGRAPHER">Photographer</th>
              <th *ngIf="role === UserRole.VETERAN">Location</th>
              <th *ngIf="role === UserRole.VETERAN">Postal Code</th>
              <th *ngIf="role !== UserRole.VETERAN">Veteran</th>
              <th *ngIf="role === UserRole.PHOTOGRAPHER">Location</th>
              <th *ngIf="role === UserRole.PHOTOGRAPHER">Postal Code</th>
              <th>Expiration</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let s of rows; trackBy: trackById">
              <td>{{ s.name }}</td>
              <td>{{ s.date | date: 'medium' }}</td>
              <td *ngIf="role !== UserRole.PHOTOGRAPHER">{{ fullName(s.photographer) }}</td>
              <td *ngIf="role === UserRole.VETERAN">{{ locationOf(s.photographer) }}</td>
              <td *ngIf="role === UserRole.VETERAN">{{ s.photographer?.postalCode || '' }}</td>
              <td *ngIf="role !== UserRole.VETERAN">{{ fullName(s.veteran) }}</td>
              <td *ngIf="role === UserRole.PHOTOGRAPHER">{{ locationOf(s.veteran) }}</td>
              <td *ngIf="role === UserRole.PHOTOGRAPHER">{{ s.veteran?.postalCode || '' }}</td>
              <td>{{ s.expirationDate | date: 'medium' }}</td>
              <!-- <td>
                  <span class="badge" [ngClass]="getBadgeClass(s.status)">{{ getStatusText(s.status) }}</span>
                </td> -->
              <td>
                <span class="d-block">
                  <i class="badge-circle f-10 m-r-5" [ngClass]="getBadgeClass(s.status)"></i>
                  {{ getStatusText(s.status) }}
                </span>
              </td>
              <td>
                <div ngbDropdown class="d-inline-block" container="body">
                  <button class="btn btn-outline-primary btn-sm" ngbDropdownToggle [disabled]="loading">Actions</button>
                  <div ngbDropdownMenu>
                    <button
                      ngbDropdownItem
                      (click)="openRescheduleModal(s)"
                      *ngIf="s.status === SessionStatus.RESCHEDULE_REQUESTED || s.status === SessionStatus.REQUESTED"
                    >
                      Reschedule
                    </button>
                    <button
                      ngbDropdownItem
                      (click)="updateSessionStatus(s.id, SessionStatus.SCHEDULED)"
                      *ngIf="
                        (role === UserRole.PHOTOGRAPHER && s.status === SessionStatus.REQUESTED) ||
                        (role === UserRole.PHOTOGRAPHER && s.status === SessionStatus.RESCHEDULE_REQUESTED) ||
                        (role === UserRole.VETERAN && s.status === SessionStatus.RESCHEDULE_REQUESTED)
                      "
                    >
                      Approve
                    </button>
                    <button
                      ngbDropdownItem
                      (click)="updateSessionStatus(s.id, SessionStatus.COMPLETED)"
                      *ngIf="s.status === SessionStatus.RESCHEDULE_REQUESTED || s.status === SessionStatus.REQUESTED"
                    >
                      Complete
                    </button>
                    <button
                      ngbDropdownItem
                      (click)="updateSessionStatus(s.id, SessionStatus.CANCELED)"
                      *ngIf="s.status === SessionStatus.RESCHEDULE_REQUESTED || s.status === SessionStatus.REQUESTED"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              </td>
            </tr>
            <tr *ngIf="rows.length === 0">
              <td colspan="7" class="text-muted">No sessions found.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="d-flex justify-content-between align-items-center mt-3">
        <div>
          <label class="me-2">Rows per page:</label>
          <select class="form-select d-inline-block" style="width: auto" [ngModel]="pageSize" (ngModelChange)="changePageSize($event)">
            <option [ngValue]="10">10</option>
            <option [ngValue]="20">20</option>
            <option [ngValue]="50">50</option>
          </select>
        </div>

        <div class="d-flex align-items-center gap-2">
          <button class="btn btn-outline-secondary" [disabled]="page <= 1" (click)="prevPage()">Prev</button>
          <span>Page {{ page }} / {{ totalPages }}</span>
          <button class="btn btn-outline-secondary" [disabled]="page >= totalPages" (click)="nextPage()">Next</button>
        </div>
      </div>
    </div>
  </div>
</div>
