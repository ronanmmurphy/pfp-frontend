<div class="modal-header">
  <h5 class="modal-title">New Session</h5>
  <button type="button" class="btn-close" (click)="close()" [disabled]="loading"></button>
</div>

<div class="modal-body" [formGroup]="sessionForm">
  <!-- Veteran Location -->
  <p>
    <strong>Your Location:</strong>
    <br />
    {{ getLocationText(user?.streetAddress1, user?.streetAddress2, user?.city, user?.state) }}
  </p>

  <!-- Location Filter -->
  <div class="mb-3">
    <label class="form-label"><strong>Search for photographers within:</strong></label>
    <select class="form-select" [(ngModel)]="selectedRadius" (ngModelChange)="onRadiusChange()" [ngModelOptions]="{ standalone: true }">
      <option *ngFor="let option of locationOptions" [value]="option">
        {{ option === 'Nearest to me' ? option : option === 'Custom Radius...' ? option : 'Within ' + option + ' miles' }}
      </option>
    </select>
    <div *ngIf="selectedRadius === 'Custom Radius...'" class="d-flex align-items-center gap-2 mt-3">
      <input
        class="form-control"
        type="number"
        placeholder="Enter radius in miles"
        [(ngModel)]="customRadius"
        [ngModelOptions]="{ standalone: true }"
        min="1"
      />
      <button class="btn btn-primary" (click)="onRadiusChange()" [disabled]="!customRadius || loading">Search</button>
    </div>
  </div>

  <!-- Map -->
  <div class="map-container mb-3">
    <div id="leafletMap" class="rounded border" style="height: 300px"></div>
  </div>

  <!-- Loading Indicator -->
  <div *ngIf="loading" class="text-center mb-3">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Photographer Table -->
  <div class="table-responsive" *ngIf="!loading && filteredPhotographers.length > 0">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Select</th>
          <th>Name</th>
          <th>Location</th>
          <th>Postal Code</th>
          <th>Distance (miles)</th>
        </tr>
      </thead>
      <tbody>
        <tr
          *ngFor="let photographer of filteredPhotographers"
          [ngClass]="{ 'table-active': selectedPhotographer?.user_id === photographer.user_id }"
          (click)="selectPhotographer(photographer)"
        >
          <td>
            <input
              type="radio"
              [value]="photographer.user_id"
              [(ngModel)]="selectedPhotographer.user_id"
              [ngModelOptions]="{ standalone: true }"
            />
          </td>
          <td>{{ getFullName(photographer.user_first_name, photographer.user_last_name) }}</td>
          <td>
            {{
              getLocationText(
                photographer.user_street_address1,
                photographer?.user_street_address2,
                photographer?.user_city,
                photographer?.user_state
              )
            }}
          </td>
          <td>{{ photographer?.user_postal_code }}</td>
          <td>{{ photographer.distance.toFixed(2) }}</td>
        </tr>
      </tbody>
    </table>
  </div>
  <div *ngIf="!loading && filteredPhotographers.length === 0" class="alert alert-info">
    No photographers found within the selected radius.
  </div>

  <!-- Session Form -->
  <div class="mt-4">
    <div class="form-group mb-3">
      <label class="form-label" for="sessionName">
        Session Name
        <span class="text-danger">*</span>
      </label>
      <input
        id="sessionName"
        type="text"
        class="form-control"
        formControlName="sessionName"
        placeholder="Session Name"
        [ngClass]="{ 'is-invalid': sessionForm.get('sessionName')?.touched && sessionForm.get('sessionName')?.invalid }"
      />
      <div class="invalid-feedback" *ngIf="sessionForm.get('sessionName')?.touched && sessionForm.get('sessionName')?.hasError('required')">
        Session name is required.
      </div>
    </div>
    <div class="form-group mb-3">
      <label class="form-label" for="sessionNote">Session Note</label>
      <textarea id="sessionNote" class="form-control" formControlName="sessionNote" placeholder="Session Note (optional)"></textarea>
    </div>
    <div class="form-group mb-3">
      <label class="form-label" for="sessionDate">
        Date
        <span class="text-danger">*</span>
      </label>
      <input
        id="sessionDate"
        type="datetime-local"
        class="form-control"
        formControlName="sessionDate"
        [ngClass]="{ 'is-invalid': sessionForm.get('sessionDate')?.touched && sessionForm.get('sessionDate')?.invalid }"
      />
      <div class="invalid-feedback" *ngIf="sessionForm.get('sessionDate')?.touched && sessionForm.get('sessionDate')?.hasError('required')">
        Session date is required.
      </div>
    </div>
    <div class="form-group mb-3">
      <label class="form-label" for="sessionExpirationDate">Expiration Date</label>
      <input id="sessionExpirationDate" type="datetime-local" class="form-control" formControlName="sessionExpirationDate" />
    </div>
  </div>
</div>

<div class="modal-footer">
  <button class="btn btn-secondary" (click)="close()" [disabled]="loading">Cancel</button>
  <button class="btn btn-primary" [disabled]="!selectedPhotographer || sessionForm.invalid || loading" (click)="requestSession()">
    Request
  </button>
</div>
